## 原始套接字

原始套接字能够处理ICMP，IGMP等协议的分组；可以处理内核不支持的IPv4/6协议；可以自行构造IPv4首部。

原始套接字直接访问IP数据报.

### 原始套接字的创建

socket(AF_INET,SOCK_RAW,protocol); //IPv4的原始套接字创建

protocol指明协议，如IPPROTO_IGMP。

### 说明

1、只有超级用户可以创建原始套接字。

2、原始套接字不存在端口的概念。

3、可以调用bind、connect（二者只能指定IP，不能指定端口）但是比较少见。


### 原始套接字输出

这里只说明IPv4，IPv6参看书籍。

不自己构造IP首部，即IP_HDRINCL选项不开启时，进程设置的是IP数据报首部后的字节，IP数据报的首部由内核构建。所以在ping程序中，只需要设置ICMP数据报的格式，不必考虑IP数据报。

如果自己构造数据报，即IP_HDRINCL开启，那么进程需要设置整个IP数据报，包括IP首部，如果IPv4的标识设置为0，则内核将设置标识字段。IPv4的校验和由内核计算。IPv4的选项字段可选。

内核会对超出MTU的分组分片。

注意：在使用原始套接字时，一定要清晰输出需要进程设置什么，从而在相应的发送缓冲区中结合对应的结构进行设置。

### 原始套接字输入

1、UDP和TCP分组不传到原始套接字

2、所有IGMP分组和接收大多数ICMP分组在内核处理完其中的消息后，传递到原始套接字

3、内核不认识其协议字段 的IP数据报

具体传递到那个套接字要进行以下三个检测：1、数据报的协议字段。2、源IP。3、目的IP。

IPv4传递完整的数据报；而IPv6传递净荷。（注意这里只对于原始套接字的输入而言）

所以对于IPv4的原始套接字的输入数据而言，需要我们处理整个IP数据报。也就是接受缓冲区中对应的是整个IP数据报。

ICMPv6协议的原始套接字存在过滤功能，以减少接收的数据报。但在设置套接字选项前还是可能接收到不需要的数据报，程序中要处理这部分数据报。


